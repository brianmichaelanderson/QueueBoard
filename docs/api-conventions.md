# API Conventions

Purpose
- Human-friendly canonical conventions for QueueBoard API contracts: status codes, concurrency, pagination, error shapes, headers, and testing guidance. The OpenAPI/Swagger spec generated by the API project is the canonical machine-readable source; this doc complements it with conventions and examples.

Canonical sources
- Machine: the API project's generated OpenAPI/Swagger JSON
- Human: this file and the resource-level examples under `docs/agents.md` and `docs/queues.md`
- Error/ProblemDetails canonical examples: `docs/error-handling.md`
- ETag mechanics and canonical precondition responses: `docs/etag.md`

Status codes & idempotency
- `200 OK` — successful GET return with resource or collection.
- `201 Created` — successful POST that created a resource; return the created resource (or Location header) and an `ETag` header when applicable.
- `204 NoContent` — successful PUT/DELETE where no response body is required.
- `400 Bad Request` — validation errors; use `ValidationProblemDetails` (see `docs/error-handling.md`).
- `404 Not Found` — resource not found.
- `409 Conflict` / `412 Precondition Failed` — concurrency or domain conflict (e.g., stale `rowVersion` or uniqueness violation). Prefer `412` when `If-Match` precondition fails.
- `500 Internal Server Error` — unhandled errors; responses use `application/problem+json` and include `traceId` per `docs/error-handling.md`.

ETag / Concurrency (summary)
- The API uses optimistic concurrency and exposes an `ETag` header on GET and POST and a `rowVersion` property in DTOs.
- Token format: base64-encoded 8-byte little-endian `long` of `UpdatedAt.UtcTicks` (see `docs/etag.md` for full details and canonical `412` example).
- Client update patterns:
  - Provide `If-Match: "<etag>"` header, or include `rowVersion` in the request body; header wins if both present.
  - On success: `204 NoContent` and a new `ETag` header with the updated token.
  - On mismatch: `412 Precondition Failed` (or `409` in some domain scenarios) with `application/problem+json`.

Pagination conventions
- Query inputs (list endpoints): `search` (string), `page` (1-based), `pageSize` (int).
- Recommended response envelope (body) for list endpoints (consistent across features):

```json
{
  "items": [ /* array of DTOs */ ],
  "total": 123,
  "page": 1,
  "pageSize": 25
}
```

- Rationale: body envelope keeps pagination metadata discoverable and testable; headers may be used in addition for convenience but don't replace the body envelope.
- Next step (optional): add a shared `PagedResult<T>` DTO and unit tests that assert controllers return the standard envelope.

Error responses & ProblemDetails
- All error responses use `application/problem+json` and follow the rules in `docs/error-handling.md`.
- Always include `traceId` in ProblemDetails and mirror correlation header (`X-Correlation-ID`) when present.
- Validation errors: return `ValidationProblemDetails` with an `errors` object mapping field names to string arrays.

DTOs, mapping, and validation
- Keep DTOs separate from EF entities. Map explicitly (AutoMapper or hand-written mapping profiles).
- DTOs should carry `rowVersion`/`RowVersion` when concurrency is applicable.
- Use DataAnnotation attributes on DTOs for MVP validation (`[Required]`, `[StringLength]`, `[Range]`), with tests exercising model validation.
- Prefer projection queries (`Select` into DTO) for list endpoints to avoid eager-loading unnecessary navigation props.

OpenAPI / XML comments
- Add XML comments to controllers and DTOs to populate Swagger examples and descriptions. Include `<example>` tags for sample request body snippets where helpful.
- Keep the generated OpenAPI spec as the single source of truth for request/response shapes; use this doc for conventions and examples.

Headers & tracing
- Correlation header: `X-Correlation-ID` (optional client-supplied). Mirror it in responses and include `traceId` in `ProblemDetails`.
- ETag header: emitted as `ETag: "<base64>"` on GET/POST and on successful mutating operations.
- Authentication/authorization (future): standard Authorization Bearer token header; not implemented in MVP but reserve space in conventions for role/claim rules.

Logging & audit
- Emit structured logs (Serilog) for resource lifecycle events (create/update/delete) including `traceId`, user identifier when available, and resource id.
- Do not leak sensitive data in logs. Store detailed exception info in logs, not in responses.

Testing Guidance
- Unit tests:
  - Assert `application/problem+json` shape for error responses, presence of `status` and `traceId`, and validation `errors` keys.
  - Controller tests should assert `ETag` header emission on GET/POST and concurrency failure mapping to `412`/`409`.
- Integration tests:
  - Use the SDK/container runner to exercise full middleware (correlation, exception-handling, db seeds).
  - Include end-to-end tests for create → get → update (using `If-Match`) → delete behavior.

Resource-level examples
- For resource-level curl examples and concrete snippets, see `docs/agents.md` and `docs/queues.md`.

Next steps / housekeeping
- Optional follow-ups: standardize a `PagedResult<T>` DTO and update controllers to return the envelope; add `docs/mapping.md` describing mapping conventions and any AutoMapper profiles.

---

File: docs/api-conventions.md
