services:
  db:
    # Use the official SQL Server image (amd64) and run under emulation on arm64 hosts
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    env_file: .env
    environment:
      - SA_PASSWORD=${SA_PASSWORD}
      - ACCEPT_EULA=${ACCEPT_EULA}
    ports:
      - '1433:1433'
    volumes:
      - mssql-data:/var/opt/mssql
    restart: unless-stopped
    # Simple TCP-based healthcheck using bash /dev/tcp (avoids sqlcmd dependency)
    healthcheck:
      test: ['CMD-SHELL', 'bash -c "cat < /dev/tcp/127.0.0.1/1433 >/dev/null 2>&1 || exit 1"']
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  mssql-data:
