services:
  db:
    # Use the official SQL Server image (amd64) and run under emulation on arm64 hosts
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    env_file: .env
    environment:
      - SA_PASSWORD=${SA_PASSWORD}
      - ACCEPT_EULA=${ACCEPT_EULA}
    ports:
      - "${DB_PORT}:1433"
    volumes:
      - mssql-data:/var/opt/mssql
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Simple TCP-based healthcheck using bash /dev/tcp (avoids sqlcmd dependency)
    healthcheck:
      test: ['CMD-SHELL', 'bash -c "echo > /dev/tcp/127.0.0.1/1433 >/dev/null 2>&1 || exit 1"']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  api:
    # Use the SDK image so we can run `dotnet run` from the checked-out source for local dev.
    image: mcr.microsoft.com/dotnet/sdk:10.0
    platform: linux/amd64
    env_file: .env
    environment:
      - ASPNETCORE_URLS=${ASPNETCORE_URLS}
      - ASPNETCORE_ENVIRONMENT=Development
      - DOTNET_USE_POLLING_FILE_WATCHER=1
    volumes:
      - ./:/src:cached
      - ./logs:/var/log/queueboard
    working_dir: /src
    # For quieter logs during verification run `dotnet run` instead of `dotnet watch`.
    # This runs without hot-reload and is preferred when capturing structured logs.
    command: bash -lc "dotnet restore server/QueueBoard.Api && dotnet run --project server/QueueBoard.Api --urls \"${ASPNETCORE_URLS:-http://0.0.0.0:8080}\""
    ports:
      - "${API_PORT:-8080}:8080"
    depends_on:
      - db
    restart: unless-stopped

volumes:
  mssql-data:
